<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Solar Battery Analysis</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
        body {
            background: #f6f8fa;
        }
        .header {
            background: #003366;
            color: #fff;
            padding: 2rem 0 1rem 0;
            border-radius: 0 0 1rem 1rem;
            margin-bottom: 2rem;
        }
        .logo {
            width: 48px;
            height: 48px;
            background: #fff;
            border-radius: 50%;
            display: inline-block;
            margin-right: 1rem;
            vertical-align: middle;
        }
        .footer {
            margin-top: 3rem;
            padding: 1rem 0;
            color: #888;
            text-align: center;
            font-size: 0.95rem;
        }
        .card {
            box-shadow: 0 2px 8px rgba(0,0,0,0.04);
            border-radius: 1rem;
        }
        .section-title {
            border-left: 4px solid #003366;
            padding-left: 0.5rem;
            margin-top: 2rem;
            margin-bottom: 1rem;
            font-weight: 600;
            color: #003366;
        }
        .form-label {
            font-weight: 500;
        }
        .btn-primary {
            background: linear-gradient(90deg, #0052cc 0%, #007fff 100%);
            border: none;
            font-weight: 600;
            letter-spacing: 0.5px;
        }
        .table thead th {
            background: #e3eaf2;
            color: #003366;
        }
        .table-striped>tbody>tr:nth-of-type(odd)>* {
            background-color: #f2f6fa;
        }
    </style>
</head>
<body>
<div class="header text-center">
    <span class="logo d-inline-block align-middle"></span>
    <span class="h2 align-middle">Solar Battery Analysis</span>
    <div class="mt-2">Visualize your solar and battery savings</div>
</div>
<div class="container mb-5">
    <div class="row justify-content-center">
        <div class="col-lg-10">
            <div class="card p-4 mb-4">
                <form method="post" class="row g-3 align-items-end">
                    {% for key, value in params.items() %}
                    <div class="col-md-4">
                        <label for="{{key}}" class="form-label">{% if key == 'battery_cost' %}Battery Cost (USD){% else %}{{key.replace('_', ' ').capitalize()}}{% endif %}</label>
                        <input type="text" class="form-control" id="{{key}}" name="{{key}}" value="{{value}}">
                    </div>
                    {% endfor %}
                    <div class="col-12 text-end mt-3">
                        <button type="submit" class="btn btn-primary btn-lg px-4">Run Simulation</button>
                    </div>
                </form>
            </div>
            {% if summary %}
            <div class="card p-4 mb-4">
                <div class="section-title">Data Summary</div>
                <div class="row mb-2">
                    <div class="col-md-6">
                        <ul class="list-group list-group-flush">
                            <li class="list-group-item"><b>Total Days Analyzed:</b> {{summary.total_days}}</li>
                            <li class="list-group-item"><b>Date Range:</b> {{summary.date_range}}</li>
                            <li class="list-group-item"><b>Average Daily Production:</b> {{summary.avg_daily_prod|round(2)}}</li>
                            <li class="list-group-item"><b>Total Solar Production:</b> {{summary.total_prod|round(2)}}</li>
                        </ul>
                    </div>
                </div>
                <div class="section-title">Daily Energy Flow (No Battery Scenario)</div>
                <div class="row mb-2">
                    <div class="col-md-6">
                        <ul class="list-group list-group-flush">
                            <li class="list-group-item"><b>Daily Grid Purchases:</b> {{summary.avg_grid_purchase|round(2)}}</li>
                            <li class="list-group-item"><b>Daily Feed-in:</b> {{summary.avg_feed_in|round(2)}}</li>
                            <li class="list-group-item"><b>Daily Net Cost:</b> {{summary.avg_net_cost|round(2)}}</li>
                            <li class="list-group-item"><b>Self-consumption Rate:</b> {{(summary.avg_self_consumption * 100)|round(2)}}%</li>
                        </ul>
                    </div>
                </div>
                <div class="section-title">Battery Performance Analysis</div>
                <div class="row mb-2">
                    <div class="col-md-6">
                        <ul class="list-group list-group-flush">
                            <li class="list-group-item"><b>Daily Grid Purchases (With Battery):</b> {{summary.avg_grid_purchase_batt|round(2)}}</li>
                            <li class="list-group-item"><b>Daily Battery Charging:</b> {{summary.avg_charge|round(2)}}</li>
                            <li class="list-group-item"><b>Daily Battery Discharge:</b> {{summary.avg_discharge|round(2)}}</li>
                            <li class="list-group-item"><b>Daily Battery Utilization:</b> {{(summary.avg_utilization * 100)|round(2)}}%</li>
                            <li class="list-group-item"><b>Daily Savings:</b> {{summary.avg_savings|round(2)}}</li>
                        </ul>
                    </div>
                </div>
                <div class="section-title">Financial</div>
                <div class="row mb-2">
                    <div class="col-md-6">
                        <ul class="list-group list-group-flush">
                            <li class="list-group-item"><b>Annual Savings (No Battery vs All-Grid):</b> {{summary.annual_savings_no_batt|round(2)}}</li>
                            <li class="list-group-item"><b>Additional Annual Savings (With Battery):</b> {{summary.additional_annual_savings|round(2)}}</li>
                            <li class="list-group-item"><b>Payback Period (years):</b> {{summary.payback_period|round(2) if summary.payback_period else 'N/A'}}</li>
                            <li class="list-group-item"><b>Annual ROI:</b> {{summary.annual_roi|round(2)}}%</li>
                        </ul>
                    </div>
                </div>
            </div>
            {% endif %}
            {% if chart_data %}
            <div class="card p-4 mb-4">
                <div class="section-title">Charts</div>
                <div class="mb-4">
                    <h5>Daily Electricity Purchased: With vs Without Battery</h5>
                    <canvas id="dailyGridPurchaseChart" height="80"></canvas>
                </div>
                <div class="mb-4">
                    <h5>Daily Cumulative Savings</h5>
                    <canvas id="dailyCumulativeSavingsChart" height="80"></canvas>
                </div>
                <div class="mb-4">
                    <h5>Monthly Summary</h5>
                    <canvas id="monthlySummaryChart" height="80"></canvas>
                </div>
            </div>
            <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
            <script>
                const chartData = {{ chart_data|safe }};
                // 1. Daily Electricity Purchased: With vs Without Battery
                const dates = chartData.map(row => row.date);
                const gridNoBattery = chartData.map(row => row.import_from_grid_without_battery_kwh);
                const gridWithBattery = chartData.map(row => row.battery_grid_import_kwh);
                new Chart(document.getElementById('dailyGridPurchaseChart').getContext('2d'), {
                    type: 'line',
                    data: {
                        labels: dates,
                        datasets: [
                            { label: 'Without Battery', data: gridNoBattery, borderColor: '#e74c3c', fill: false },
                            { label: 'With Battery', data: gridWithBattery, borderColor: '#2980b9', fill: false }
                        ]
                    },
                    options: {
                        responsive: true,
                        plugins: { legend: { position: 'top' } },
                        scales: { x: { ticks: { maxTicksLimit: 14, autoSkip: true } } }
                    }
                });
                // 2. Daily Cumulative Savings
                let cumulative = 0;
                const cumulativeSavings = chartData.map(row => (cumulative += row.battery_daily_savings));
                new Chart(document.getElementById('dailyCumulativeSavingsChart').getContext('2d'), {
                    type: 'line',
                    data: {
                        labels: dates,
                        datasets: [
                            { label: 'Cumulative Savings ($)', data: cumulativeSavings, borderColor: '#27ae60', fill: true, backgroundColor: 'rgba(39,174,96,0.1)' }
                        ]
                    },
                    options: {
                        responsive: true,
                        plugins: { legend: { position: 'top' } },
                        scales: { x: { ticks: { maxTicksLimit: 14, autoSkip: true } } }
                    }
                });
                // 3. Monthly Summary
                const monthMap = {};
                chartData.forEach(row => {
                    const month = row.date.slice(0,7);
                    if (!monthMap[month]) monthMap[month] = { production: 0, gridWith: 0, gridNo: 0 };
                    monthMap[month].production += row.production_kwh;
                    monthMap[month].gridWith += row.battery_grid_import_kwh;
                    monthMap[month].gridNo += row.import_from_grid_without_battery_kwh;
                });
                const months = Object.keys(monthMap);
                const prod = months.map(m => monthMap[m].production);
                const gridWith = months.map(m => monthMap[m].gridWith);
                const gridNo = months.map(m => monthMap[m].gridNo);
                new Chart(document.getElementById('monthlySummaryChart').getContext('2d'), {
                    type: 'line',
                    data: {
                        labels: months,
                        datasets: [
                            { label: 'Production (kWh)', data: prod, borderColor: '#f1c40f', fill: false },
                            { label: 'Grid Purchase (With Battery)', data: gridWith, borderColor: '#2980b9', fill: false },
                            { label: 'Grid Purchase (No Battery)', data: gridNo, borderColor: '#e74c3c', fill: false }
                        ]
                    },
                    options: {
                        responsive: true,
                        plugins: { legend: { position: 'top' } },
                        scales: { x: { ticks: { maxTicksLimit: 12, autoSkip: true } } }
                    }
                });
            </script>
            {% endif %}
            {% if results %}
            <div class="card p-4 mb-4">
                <div class="section-title">Simulation Results (First 10 Days)</div>
                <div class="table-responsive">
                    <table class="table table-striped table-hover">
                        <thead>
                        <tr>
                            {% for col in results[0].keys() %}
                            <th>{{col.replace('_', ' ').capitalize()}}</th>
                            {% endfor %}
                        </tr>
                        </thead>
                        <tbody>
                        {% for row in results[:10] %}
                        <tr>
                            {% for val in row.values() %}
                            <td>{{val}}</td>
                            {% endfor %}
                        </tr>
                        {% endfor %}
                        </tbody>
                    </table>
                </div>
            </div>
            {% endif %}
        </div>
    </div>
</div>
<div class="footer">
    &copy; {{2025}} Solar Battery Analysis &mdash; Powered by Flask &amp; Bootstrap
</div>
</body>
</html> 